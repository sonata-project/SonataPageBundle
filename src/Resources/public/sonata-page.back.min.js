/*
 * This file is part of the Sonata Project package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
(function(c,w){function n(a){"undefined"==typeof w.admin&&Admin.shared_setup(a)}var v=function(a,d){var b=d||{};this.pageId=a;this.$container=c(".page-composer");this.$dynamicArea=c(".page-composer__dyn-content");this.$pagePreview=c(".page-composer__page-preview");this.$containerPreviews=this.$pagePreview.find(".page-composer__page-preview__container");this.routes=c.extend({},b.routes||{});this.translations=c.extend({},b.translations||{});this.csrfTokens=c.extend({},b.csrfTokens||{});this.bindPagePreviewHandlers();
this.bindOrphansHandlers();var e=this,b=c(this);b.on("containerclick",function(a){e.loadContainer(a.$container)});b.on("containerloaded",this.handleContainerLoaded);b.on("blockcreated",this.handleBlockCreated);b.on("blockremoved",this.handleBlockRemoved);b.on("blockcreateformloaded",this.handleBlockCreateFormLoaded);b.on("blockpositionsupdate",this.handleBlockPositionsUpdate);b.on("blockeditformloaded",this.handleBlockEditFormLoaded);b.on("blockparentswitched",this.handleBlockParentSwitched)};v.prototype=
{translate:function(a){return this.translations[a]?this.translations[a]:a},getRouteUrl:function(a,c){if(!this.routes[a])throw Error('Route "'+a+'" does not exist');var b=this.routes[a],d;for(d in c)b=b.replace(new RegExp(d),c[d]);return b},isFormControlTypeByName:function(a,c){if("undefined"!=typeof a){var b=a.length,d="["+c+"]",g=a.lastIndexOf(d),b=b-d.length;return-1!==g&&g===b}return!1},handleBlockCreated:function(a){var d=this;c.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:a.blockId}),
type:"GET",success:function(b){b=c(b);a.$childBlock.replaceWith(b);d.controlChildBlock(b);b=d.getContainerChildCountFromList(a.parentId);null!==b&&d.updateChildCount(a.parentId,b)},error:function(){d.containerNotification("composer_preview_error","error",!0)}})},handleBlockRemoved:function(a){var c=this.getContainerChildCountFromList(a.parentId);null!==c&&this.updateChildCount(a.parentId,c)},containerNotification:function(a,d,b){var e=this.$dynamicArea.find(".page-composer__container__view__notice");
1===e.length&&(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),e.removeClass("persist success error"),d&&e.addClass(d),e.text(this.translate(a)),e.show(),!0!==b?this.containerNotificationTimer=setTimeout(function(){e.hide().empty()},2E3):(a=c('<span class="close-notice">x</span>'),a.on("click",function(){e.hide().empty()}),e.addClass("persist"),e.append(a)))},handleBlockPositionsUpdate:function(a){var d=this;this.containerNotification("composer_update_saving");c.ajax({url:this.getRouteUrl("save_blocks_positions"),
type:"POST",data:{disposition:a.disposition},success:function(a){a.result&&"ok"===a.result&&d.containerNotification("composer_update_saved","success")},error:function(){d.containerNotification("composer_update_error","error",!0)}})},handleBlockParentSwitched:function(a){var d=c(".block-preview-"+a.previousParentId).find(".child-count"),d=parseInt(d.text().trim(),10),b=c(".block-preview-"+a.newParentId).find(".child-count"),b=parseInt(b.text().trim(),10);this.updateChildCount(a.previousParentId,d-
1);this.updateChildCount(a.newParentId,b+1)},getContainerChildCountFromList:function(a){a=this.$dynamicArea.find(".block-view-"+a);if(0===a.length)return null;var d=0;a.find(".page-composer__container__child").each(function(){"undefined"!=typeof c(this).attr("data-block-id")&&d++});return d},updateChildCount:function(a,d){var b=c(".block-preview-"+a),e=c(".block-view-"+a);0<b.length&&b.find(".child-count").text(d);0<e.length&&e.find(".page-composer__container__child-count span").text(d)},handleBlockCreateFormLoaded:function(a){var d=
this,b=this.$dynamicArea.find(".page-composer__container__children"),e=this.$dynamicArea.find(".page-composer__container__main-edition-area");if(a.container){var g=a.container;var h=g.find(".page-composer__container__child__content");h.html(a.response)}else g=c(['<li class="page-composer__container__child"><a class="page-composer__container__child__edit"><h4 class="page-composer__container__child__name"><input type="text" class="page-composer__container__child__name__input"></h4></a><div class="page-composer__container__child__right">',
'<span class="badge">'+a.blockTypeLabel+"</span>",'</div><div class="page-composer__container__child__content"></div></li>'].join("")),h=g.find(".page-composer__container__child__content"),h.append(a.response),b.append(g),h.show();var k=g.find("form"),f=k.attr("action"),q=k.attr("method"),m=k.find("input, select, textarea"),l=k.find(".form-actions"),x=this.$dynamicArea.find(".page-composer__container__child__name"),r,t,u;n(k);c(document).scrollTo(g,200);e.show();m.each(function(){var e=c(this),g=
e.attr("name");d.isFormControlTypeByName(g,"name")?(r=e,x.find(".page-composer__container__child__name__input").bind("propertychange keyup input paste",function(a){r.val(c(this).val())})):d.isFormControlTypeByName(g,"parent")?(t=e,t.val(a.containerId),t.parent().parent().hide()):d.isFormControlTypeByName(g,"position")&&(u=e,u.val(b.find("> *").length),u.closest(".form-group").hide())});l.each(function(){var a=c(this),b=c('<span class="btn btn-warning">'+d.translate("cancel")+"</span>");b.on("click",
function(a){a.preventDefault();g.remove();c(document).scrollTo(d.$dynamicArea,200)});a.append(b)});k.on("submit",function(b){b.preventDefault();var e=r.val();""===e&&(e=a.blockType);c.ajax({url:f+"&"+c.param({composer:1}),data:k.serialize(),type:q,success:function(b){if(b.result&&"ok"===b.result&&b.objectId){var f=c.Event("blockcreated");f.$childBlock=g;f.parentId=a.containerId;f.blockId=b.objectId;f.blockName=e;f.blockType=a.blockType;c(d).trigger(f)}else f=c.Event("blockcreateformloaded"),f.response=
b,f.containerId=a.containerId,f.blockType=a.blockType,f.container=g,c(d).trigger(f),n(h)}});return!1})},toggleChildBlock:function(a){var c=this.$dynamicArea.find(".page-composer__container__child"),b=a.find(".page-composer__container__child__name"),e=b.find(".page-composer__container__child__name__input");a.hasClass("page-composer__container__child--expanded")?(a.removeClass("page-composer__container__child--expanded"),b.has(".page-composer__container__child__name__input")&&b.html(e.val())):(c.not(a).removeClass("page-composer__container__child--expanded"),
a.addClass("page-composer__container__child--expanded"))},handleBlockEditFormLoaded:function(a){var d=this,b=a.$block.find(".page-composer__container__child__edit h4"),e=a.$block.find(".page-composer__container__child__content"),g=a.$block.find(".page-composer__container__child__loader"),h=e.find("form"),k=h.attr("action"),f=h.attr("method"),q=a.$block.find(".page-composer__container__child__edit small").text().trim(),m,l;h.find("input").each(function(){var a=c(this),e=a.attr("name");d.isFormControlTypeByName(e,
"name")?(m=a,b.html('<input type="text" class="page-composer__container__child__name__input" value="'+b.text()+'">'),$input=b.find("input"),$input.bind("propertychange keyup input paste",function(a){m.val($input.val())}),$input.on("click",function(a){a.stopPropagation();a.preventDefault()})):d.isFormControlTypeByName(e,"position")&&(l=a,l.closest(".form-group").hide())});h.on("submit",function(l){l.preventDefault();g.show();c.ajax({url:k,data:h.serialize(),type:f,success:function(f){g.hide();f.result&&
"ok"===f.result?("undefined"!=typeof m&&b.text(""!==m.val()?m.val():q),a.$block.removeClass("page-composer__container__child--expanded"),e.empty()):(e.html(f),f=c.Event("blockeditformloaded"),f.$block=a.$block,c(d).trigger(f),n(e))}});return!1})},controlChildBlock:function(a){var d=this,b=a.find(".page-composer__container__child__content"),e=a.find(".page-composer__container__child__loader"),g=a.find(".page-composer__container__child__edit"),h=g.attr("href"),k=a.find(".page-composer__container__child__remove").find("a"),
f=a.find(".page-composer__container__child__switch-enabled"),q=f.attr("data-label-enable"),m=f.attr("data-label-disable"),l=f.find("a"),x=l.find("i"),f=a.find(".page-composer__container__child__enabled"),r=f.find("small"),t=f.find("i"),u=l.attr("href"),p=parseInt(a.attr("data-block-enabled"),2);g.click(function(f){f.preventDefault();0<b.find("form").length?d.toggleChildBlock(a):(e.show(),c.ajax({url:h,success:function(f){b.html(f);f=c.Event("blockeditformloaded");f.$block=a;c(d).trigger(f);n(b);e.hide();
d.toggleChildBlock(a)}}))});l.on("click",function(b){b.preventDefault();c.ajax({url:u,type:"POST",data:{_sonata_csrf_token:d.csrfTokens.switchEnabled,value:!p},success:function(b){a.attr("data-block-enabled",p?"0":"1");p=!p;l.toggleClass("bg-yellow bg-green");x.toggleClass("fa-toggle-off fa-toggle-on");p?l.html(m):l.html(q);r.toggleClass("bg-yellow bg-green");t.toggleClass("fa-times fa-check");a.has("form")&&a.find("form").find("input").each(function(){var a=c(this),b=a.attr("name");d.isFormControlTypeByName(b,
"enabled")&&a.val(parseInt(!p))})},error:function(){d.containerNotification("composer_status_error","error",!0)}})});k.on("click",function(b){b.preventDefault();d.confirmRemoveContainer(a)})},confirmRemoveContainer:function(a){var d=this,b=a.find(".page-composer__container__child__remove").find("a"),e=a.find(".page-composer__container__child__remove__dialog"),g=b.attr("href"),h=parseInt(a.attr("data-parent-block-id"),10);0==e.length&&(e=c(['<div class="modal fade page-composer__container__child__remove__dialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',
'<h4 class="modal-title">'+this.translate("composer_remove_confirm")+"</h4>",'</div><div class="modal-body"></div><div class="modal-footer">','<button type="button" class="btn btn-default" data-dismiss="modal">'+this.translate("cancel")+"</button>",'<button type="button" class="btn btn-primary">'+this.translate("yes")+"</button>","</div></div></div></div>"].join("")),a.append(e));e.find(".btn-primary").on("click",function(b){c.ajax({url:g,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:d.csrfTokens.remove},
success:function(b){b.result&&"ok"===b.result&&(a.remove(),b=c.Event("blockremoved"),b.parentId=h,c(d).trigger(b))}});e.modal("hide");0!=c(".modal-backdrop").length&&c(".modal-backdrop").hide()});e.modal("show")},handleContainerLoaded:function(a){var d=this,b=this.$dynamicArea.find(".page-composer__container__children"),e=this.$dynamicArea.find(".page-composer__container__child"),g=this.$dynamicArea.find(".page-composer__block-type-selector"),h=g.find(".page-composer__block-type-selector__loader"),
k=g.find("select"),g=g.find(".page-composer__block-type-selector__confirm"),f=g.attr("href");n(this.$dynamicArea);g.on("click",function(b){b.preventDefault();h.css("display","inline-block");var e=k.val(),g=k.find("option:selected").text();c.ajax({url:f,data:{type:e},success:function(b){h.hide();c(d).trigger(c.Event("blockcreateformloaded",{response:b,containerId:a.containerId,blockType:e,blockTypeLabel:g}))}})});b.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(a,b){var d=
c(b),e=d.find(".page-composer__container__child__edit h4").text().trim();d.find(".page-composer__container__child__edit small").text().trim();d.removeClass("page-composer__container__child--expanded");return c('<div class="page-composer__container__child__helper"><h4>'+e+"</h4></div>")},update:function(a,e){var f=[];b.find(".page-composer__container__child").each(function(a){var b=c(this),e=b.attr("data-parent-block-id"),b=b.attr("data-block-id");"undefined"!=typeof b&&f.push({id:parseInt(b,10),position:a,
parent_id:parseInt(e,10),page_id:d.pageId})});if(0<f.length){var g=c.Event("blockpositionsupdate");g.disposition=f;c(d).trigger(g)}}});e.each(function(){d.controlChildBlock(c(this))})},bindPagePreviewHandlers:function(){var a=this;this.$containerPreviews.each(function(){var d=c(this);d.on("click",function(b){b.preventDefault();b=c.Event("containerclick");b.$container=d;c(a).trigger(b)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".page-composer__container__children",
accept:function(a){var b=c(this).attr("data-block-whitelist");if(""===b)return!0;b=b.split(",");a=c(a).attr("data-block-type");return-1!==b.indexOf(a)},drop:function(d,b){var e=b.draggable.attr("data-block-id");if("undefined"!=typeof e){b.helper.remove();var g=c(this),h=parseInt(b.draggable.attr("data-parent-block-id"),10),k=parseInt(g.attr("data-block-id"),10),e=parseInt(e,10);h!==k&&(g.addClass("dropped"),g.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){g.removeClass("dropped")}),
c.ajax({url:a.getRouteUrl("block_switch_parent"),data:{block_id:e,parent_id:k},success:function(d){d.result&&"ok"===d.result&&(b.draggable.remove(),d=c.Event("blockparentswitched"),d.previousParentId=h,d.newParentId=k,d.blockId=e,c(a).trigger(d))}}))}}});0<this.$containerPreviews.length&&this.loadContainer(this.$containerPreviews.eq(0))},bindOrphansHandlers:function(){var a=this;this.$container.find(".page-composer__orphan-container").each(function(){var d=c(this);d.on("click",function(b){b.preventDefault();
b=c.Event("containerclick");b.$container=d;c(a).trigger(b)})})},loadContainer:function(a){var d=a.attr("href"),b=a.attr("data-block-id"),e=this;this.$dynamicArea.empty();this.$containerPreviews.removeClass("active");this.$container.find(".page-composer__orphan-container").removeClass("active");a.addClass("active");c.ajax({url:d,success:function(a){e.$dynamicArea.html(a);c(document).scrollTo(e.$dynamicArea,200,{offset:{top:-100}});a=c.Event("containerloaded");a.containerId=b;c(e).trigger(a)}})}};w.PageComposer=
v;c(function(){c("[data-page-composer]").each(function(){var a=c(this).data("page-composer");new v(a.pageId,a)})})})(jQuery,window);
(function(c,w,n,v){function a(a,e){this.element=a;this.options=c.extend({},d,e);this._defaults=d;this._name="treeView";this.init()}var d={togglersAttribute:"[data-treeview-toggler]",toggledState:"is-toggled"};a.prototype={init:function(){this.setElements();this.setEvents()},setElements:function(){this.$element=c(this.element);this.$togglers=this.$element.find(this.options.togglersAttribute)},setEvents:function(){this.$togglers.on("click",c.proxy(this.toggle,this))},toggle:function(a){a=c(a.currentTarget).parent();
a.toggleClass(this.options.toggledState);a.next("ul").slideToggle()}};c.fn.treeView=function(b){return this.each(function(){c.data(this,"plugin_treeView")||c.data(this,"plugin_treeView",new a(this,b))})};c(function(){c(".js-treeview").treeView()})})(jQuery,window,document);
